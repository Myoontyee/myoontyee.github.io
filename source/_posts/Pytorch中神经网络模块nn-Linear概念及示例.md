---
title: Pytorchä¸­ç¥ç»ç½‘ç»œæ¨¡å—nn.Linearæ¦‚å¿µåŠç¤ºä¾‹
tags:
  - Pytorch
  - Neural Network
  - Linear
category:
  - Neural Network
mathjax: true
abbrlink: a2c031de
date: 2022-05-30 11:22:58
---

---

**åˆ›å»ºæ—¶é—´**ï¼š2022å¹´5æœˆ30æ—¥09:55:15
**æœ€æ–°æ›´æ–°**ï¼š2022å¹´5æœˆ30æ—¥17:38:01

---

**Problem Description**ï¼šConcept and example of neural network module `nn.Linear` in Pytorch

**æ ¸å¿ƒæ€è·¯**ï¼š
* å¯¹è¾“å…¥æ•°æ®åº”ç”¨çº¿æ€§å˜æ¢ï¼š$ y=xA^{T}+b $ 
  * æˆ–è€…è¯´ $ Y=XW^{T}+b $
    * $ W $ å°±æ˜¯æˆ‘ä»¬å…³æ³¨çš„æƒé‡çŸ©é˜µ
    * $ b $ å°±æ˜¯æˆ‘ä»¬å…³æ³¨çš„åç½®
* `torch.nn.Linear(in_features, out_features, bias=True)`
  * ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¾“å…¥çŸ©é˜µçš„åˆ—æ•°
  * ç¬¬äºŒä¸ªå‚æ•°æ˜¯è¾“å‡ºçŸ©é˜µçš„åˆ—æ•°
  * ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯æœ‰æ²¡æœ‰åç½® $ bias $

---

* æ–‡æœ¬å†…å®¹å‚è€ƒäº†[yanghh](https://www.cnblogs.com/yanghh/p/14054163.html)çš„å·¥ä½œ
	* ä»–å†™çš„çœŸæ£’ğŸ‘ï¼

# å®šä¹‰
```Python
class
torch.nn.Linear(in_features, out_features, bias=True, device=None, dtype=None)
```

* ç”¨é€”
	* å¯¹è¾“å…¥æ•°æ®åº”ç”¨çº¿æ€§å˜æ¢ï¼š$ y=xA^{T}+b $ 
	* ç”¨äºè®¾ç½®ç½‘ç»œä¸­çš„å…¨è¿æ¥å±‚
* æ³¨æ„
	* è¾“å…¥ä¸è¾“å‡ºéƒ½æ˜¯äºŒç»´å¼ é‡
		* äºŒç»´å¼ é‡çš„ä¸€èˆ¬å½¢çŠ¶ä¸º $ [batch \ size, \ size] $

## è¾“å…¥ä¸è¾“å‡º
* è¾“å…¥
	* $ ( âˆ— , H_{ in } ) $
		* å…¶ä¸­ $ * $ ä»£è¡¨ä»»æ„æ•°é‡çš„ç»´åº¦ï¼Œå¯ä»¥å–None
	* $ ( * , H_{ out } ) $
		* é™¤äº†æœ€åä¸€ä¸ªç»´åº¦ï¼ˆæŒ‡ $ H_{ out } $ ï¼‰ä¹‹å¤–çš„æ‰€æœ‰ç»´åº¦éƒ½ä¸è¾“å…¥çš„å½¢çŠ¶ç›¸åŒï¼Œå¹¶ä¸” $  H_{out} = out \ features $

## å‚æ•°
* å…ˆå…³æ³¨ä¸€ä¸‹æ ¸å¿ƒå…¬å¼ï¼š
	* $ y=xA^{T}+b $
	* $ Y=XA^{T}+b $
* `in_features`
	* æ¯ä¸ªè¾“å…¥æ ·æœ¬çš„å¤§å°ï¼Œå³è¾“å…¥çŸ©é˜µçš„åˆ—æ•°
	* å¯¹åº”è¾“å…¥äºŒç»´å¼ é‡å½¢çŠ¶ $ [batch \ size, input \ size] $ ä¸­çš„ $ input \  size $
	* ä»£è¡¨æ¯ä¸ªæ ·æœ¬ $ x $ çš„ç‰¹å¾æ•°
		* ä¹Ÿæ˜¯è¾“å…¥å±‚ç¥ç»å…ƒçš„ä¸ªæ•°
* `out_features`
	* æ¯ä¸ªè¾“å‡ºæ ·æœ¬çš„å¤§å°ï¼Œå³è¾“å‡ºçŸ©é˜µçš„åˆ—æ•°
	* å¯¹åº”è¾“å‡ºäºŒç»´å¼ é‡å½¢çŠ¶ $ [batch \ sizeï¼Œoutput \ size] $ ä¸­çš„ $ output \  size $
	* ä»£è¡¨æ¯ä¸ªæ ·æœ¬è¾“å‡º $ y $ çš„ç‰¹å¾æ•°
		* ä¹Ÿæ˜¯è¾“å‡ºå±‚ç¥ç»å…ƒçš„ä¸ªæ•°
* `bias`
	* å¦‚æœè®¾ç½®ä¸º `False`ï¼Œè¯¥å±‚å°†ä¸ä¼šå­¦ä¹ é™„åŠ åå·®
	* é»˜è®¤å€¼ï¼š`True`
		* å¦‚æœä¸º `True`ï¼Œåˆ™ç½‘ç»œçš„è¾“å‡ºéœ€è¦å†åŠ ä¸Šä¸€ä¸ªåç½®å‘é‡ï¼Œç»´åº¦ä¸º $ output \ size $


# ç¤ºä¾‹ä¸å®ç°
## ç¤ºä¾‹
* ç¤ºä¾‹å†…å®¹æ¥è‡ª[yanghh](https://www.cnblogs.com/yanghh/p/14054163.html)ï¼Œè¯¦è§Ref

* åœ¨å°†`Transformer`å¸ƒåˆ°`FPGA`ä¸Šå¤´æ—¶ï¼Œæˆ‘ä»¬å…¶å®éœ€è¦çŸ¥é“æƒé‡çŸ©é˜µ`W`å’Œåç½®`bias`ï¼Œå•çœ‹[æ‰‹å†Œ](https://pytorch.org/docs/stable/generated/torch.nn.Linear.html#linear)è¿˜ä¸æ™“å¾—æ˜¯å’‹å›äº‹ï¼ˆåˆšå…¥é—¨å˜›...ï¼‰ï¼Œå‘è§‰[yanghh](https://www.cnblogs.com/yanghh/p/14054163.html)å†™çš„æå¥½çš„ï¼Œä¸‹é¢å°±æ˜¯ä»–çš„å·¥ä½œå†…å®¹
* å®˜æ–¹æ‰‹å†Œå†™çš„è¯¥å‡½æ•°åŠŸèƒ½ä¸ºå¯¹è¾“å…¥æ•°æ®åº”ç”¨çº¿æ€§å˜æ¢ï¼š$ y = xA^{T} + b $ 
	* è¿™ä¸ªä¸ç›´è§‚ï¼Œå®é™…ä¸Šåšçš„æ˜¯å¦‚ä¸‹å˜æ¢

$$ \begin{equation}\label{eq1}
Y = XW^{T}+b

\end{equation} 

$$
* å…¶ä¸­
	* $ X $ æ˜¯ä¸€ä¸ªçŸ©é˜µè€Œéå‘é‡
		* é€šå¸¸æ¥è‡ªäºä¸€ä¸ª $ batch $ ä¸­çš„æ ·æœ¬ï¼Œç”¨è¿™ä¸ªæ ·æœ¬ç»„æˆä¸€ä¸ªè¾“å…¥çŸ©é˜µ
		* çŸ©é˜µ $ X $ çš„æ¯ä¸€è¡Œä»£è¡¨ä¸€ä¸ªè¾“å…¥æ ·æœ¬ï¼Œå¦‚ä¸‹


$$ \tag{2}

\begin{matrix}

&Y 

\\ 

&\left[\begin{array}{cccccccccc}

? & ? & ? & ? & ? & ? & ? & ? & ? & ? \\
? & ? & ? & ? & ? & ? & ? & ? & ? & ? \\
? & ? & ? & ? & ? & ? & ? & ? & ? & ? \\
? & ? & ? & ? & ? & ? & ? & ? & ? & ?

\end{array}\right]_{4 \times 10}

\\

&X   &W^{T} &+ &b

\\
=

&
\left[\begin{array}{llllll}

1 & 3 & 1 & 2 & 5 & 6 \\
2 & 3 & 1 & 5 & 3 & 1 \\
1 & 2 & 4 & 4 & 2 & 3 \\
7 & 8 & 1 & 3 & 5 & 9

\end{array}\right]_{4 \times 6}

&
\left[\begin{array}{llllllllll}

1 & 3 & 5 & 2 & 3 & 4 & 5 & 6 & 7 & 3 \\
2 & 3 & 5 & 6 & 3 & 5 & 6 & 7 & 8 & 6 \\
5 & 4 & 3 & 6 & 3 & 4 & 2 & 4 & 7 & 4 \\
6 & 4 & 2 & 4 & 6 & 7 & 8 & 6 & 4 & 5 \\
6 & 4 & 3 & 2 & 6 & 7 & 8 & 2 & 1 & 7 \\
2 & 4 & 5 & 6 & 3 & 6 & 7 & 4 & 7 & 2

\end{array}\right]_{6 \times 10}

&+

&
\left[\begin{array}{llllllllll}

1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & 10

\end{array}\right]_{1 \times 10}

\end{matrix}

$$

* (2)å¼ä¸­
	* è¾“å…¥æ˜¯ä¸€ä¸ª $ shape $ ä¸º$(4,6)$çš„çŸ©é˜µ$X$
		* å³è¿™ä¸ªçŸ©é˜µç”± $ 4 $ ä¸ªæ ·æœ¬ç»„æˆ
		* æ¯ä¸ªæ ·æœ¬æœ‰ $ 6 $ ä¸ªç»´åº¦çš„ç‰¹å¾
	* $ W^{T} $ ä»£è¡¨å…¨è¿æ¥å±‚çš„æƒé‡çŸ©é˜µï¼Œ$ shape $ ä¸º $ (6, 10) $
		* å³æ¯ä¸ªè¾“å…¥æ ·æœ¬ï¼ˆ $ X $ çš„æ¯ä¸€è¡Œï¼‰åœ¨è¿™ä¸ªçŸ©é˜µ $ W^{T} $ çš„ä½œç”¨ä¸‹ï¼Œè¾“å‡ºç»´åº¦å˜ä¸º $ 10 $ï¼ˆè¾“å‡ºä¸€ä¸ªå‘é‡ï¼‰
	* å³è¾“å…¥å±‚æœ‰ $ 6 $ ä¸ªç¥ç»å…ƒï¼Œè¾“å‡ºå±‚æœ‰ $ 10 $ ä¸ªç¥ç»å…ƒ
	* $ b $ æ˜¯åç½®å‘é‡ï¼Œæ˜¯ $ bias $ ï¼Œå®ƒçš„ç»´åº¦ç­‰äºè¾“å‡ºç¥ç»å…ƒçš„ä¸ªæ•° $ 10 $
	* **å¹¿æ’­æœºåˆ¶ï¼ˆbroadcast mechanismï¼‰**
		* è§£é‡Šå…·ä½“è§
		* $ b $ æ˜¯ $ 1Ã—10 $ çš„å‘é‡ï¼Œ $ XW^{T} $ çš„è¾“å‡ºæ˜¯ä¸€ä¸ª $ 4Ã—10 $ çš„çŸ©é˜µ
			* æŒ‰ç†æ¥è¯´å…¶æ²¡æ³•å’Œä¸€ä¸ªå‘é‡ç›¸åŠ å•Šï¼Ÿ
			* è¿™é‡Œåº”ç”¨çš„æ˜¯ $ Tensor $ çš„**å¹¿æ’­æœºåˆ¶ï¼ˆbroadcast mechanismï¼‰**
				* å°±ä½ å¹³å¸¸ç›´æ¥ä»`GitHub`ä¸Šæç¥ç»ç½‘ç»œä»£ç ä¸‹æ¥è·‘ï¼ŒæŠ¥`broadcast`é”™è¯¯çš„é‚£ä¸ªæœºåˆ¶ 
			* $ (4, 10) $ çš„çŸ©é˜µå’Œ $ (1, 10) $ å‘é‡ç›¸ä¹˜ï¼Œç”±äºç¼ºå¤±ï¼Œè§¦å‘å¹¿æ’­æœºåˆ¶ï¼ŒæŠŠå‘é‡ $ b $ ç”± $ (1, 10) $ å˜æˆ $ (4, 10) $ çš„çŸ©é˜µ $ b' $ï¼Œæœ€ç»ˆæ‰§è¡Œçš„å®é™…æ“ä½œå¦‚ä¸‹

$$\tag{3}
\begin{matrix}
&Y 


\\ 
&\left[\begin{array}{cccccccccc}
? & ? & ? & ? & ? & ? & ? & ? & ? & ? \\
? & ? & ? & ? & ? & ? & ? & ? & ? & ? \\
? & ? & ? & ? & ? & ? & ? & ? & ? & ? \\
? & ? & ? & ? & ? & ? & ? & ? & ? & ?
\end{array}\right]_{4 \times 10}
\\
&X   &W^{T} &+ &b'
\\
&=
\left[\begin{array}{llllll}
1 & 3 & 1 & 2 & 5 & 6 \\
2 & 3 & 1 & 5 & 3 & 1 \\
1 & 2 & 4 & 4 & 2 & 3 \\
7 & 8 & 1 & 3 & 5 & 9
\end{array}\right]_{4 \times 6}

&\left[\begin{array}{llllllllll}
1 & 3 & 5 & 2 & 3 & 4 & 5 & 6 & 7 & 3 \\
2 & 3 & 5 & 6 & 3 & 5 & 6 & 7 & 8 & 6 \\
5 & 4 & 3 & 6 & 3 & 4 & 2 & 4 & 7 & 4 \\
6 & 4 & 2 & 4 & 6 & 7 & 8 & 6 & 4 & 5 \\
6 & 4 & 3 & 2 & 6 & 7 & 8 & 2 & 1 & 7 \\
2 & 4 & 5 & 6 & 3 & 6 & 7 & 4 & 7 & 2
\end{array}\right]_{6 \times 10}

&+

&\left[\begin{array}{cccccccccc}
1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & 10 \\
1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & 10 \\
1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & 10 \\
1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & 10
\end{array}\right]_{4 \times 10}


\end{matrix}

$$

## å®ç°

* ä»£ç æ¥è‡ª[yanghh](https://www.cnblogs.com/yanghh/p/14054163.html)

```Python
import torch
 
X = torch.randn(128, 20)          # è¾“å…¥çš„ç»´åº¦æ˜¯ï¼ˆ128ï¼Œ20ï¼‰
model = torch.nn.Linear(20, 30)   # 20,30 æ˜¯æŒ‡ç»´åº¦
Y = model(X)
print('model.weight.shape: ', model.weight.shape)  # çŸ©é˜µ
print('model.bias.shape: ', model.bias.shape)      # å‘é‡
print('output.shape: ', Y.shape)                   # çŸ©é˜µ
 
# ç­‰ä»·äºä¸‹é¢çš„
ans = torch.mm(X, model.weight.t()) + m.bias # Y = XW.T + b
print('ans.shape: ', ans.shape)
 
"""
model.weight.shape:  torch.Size([30, 20])
model.bias.shape:  torch.Size([30])
output.shape:  torch.Size([128, 30])
ans.shape:  torch.Size([128, 30])
"""
```

---

# Ref
* [Linear](https://pytorch.org/docs/stable/generated/torch.nn.Linear.html#linear)
* [Source code for torch.nn.modules.linear](https://pytorch.org/docs/stable/_modules/torch/nn/modules/linear.html#Linear)
* [Pytorch ç¥ç»ç½‘ç»œæ¨¡å—ä¹‹ Linear Layers](https://www.cnblogs.com/yanghh/p/14054163.html)
